<!doctype html>
<html lang="zh-cn">
<head>
	<meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>喵众 Cattie 播放页</title>
    <meta name="keywords" content="喵众 Cattie" />
    <meta name="description" content="喵众 Cattie 聚众看片，是一种逼格" />
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <link rel="stylesheet" href="css/normalize.css" /> <!-- reset style -->
	<link rel="stylesheet" href="css/base.css" /> <!-- basic style -->
    <link rel="stylesheet" type="text/css" href="css/jquery.validator.css"/> <!-- vaildform -->
	<link href="plugins/video-js.css" rel="stylesheet" type="text/css"> <!-- plugins videojs css -->


    <script src="js/vendor/jquery-1.7.2.min.js"></script> <!-- jQuery library -->
	<script src="js/vendor/jquery-ui-1.11.1.js"></script> <!-- jQuery UI library -->
	<script src="js/vendor/jquery.base64.js"></script>
	<!--<script src="js/vendor/jquery.zclip.min.js"></script>-->
	<script src="js/vendor/jquery.validator.js"></script> <!-- validform -->
	<script src="js/vendor/zh_CN.js"></script> <!-- validform Chinese -->
    <script src="js/vendor/jquery.zclip.js"></script>







    <!--[if (gte IE 6)&(lte IE 8)]>
      <script type="text/javascript" src="js/vendor/selectivizr.js"></script>
	  <script src="js/vendor/respond.min.js"></script>
    <![endif]--> <!--/*修正CSS3在IE6-8*/-->

    <!--[if lt IE 9]>
       <script src="js/html5.js"></script>
    <![endif]-->

</head>

<body style="background:url(images/bg/bg1.jpg) no-repeat; background-size:cover;">
<div class="warn-wrap">请等待管理员开播</div>
<div class="float-lay-bg"></div> <!-- 遮罩 -->
<div class="login-register-wrap">
	<!-- LR-title -->
	<div class="LR-title-wrap">
    	<span class="LR-wrap-close txt-indent">Close</span>
    	<a class="s-logo txt-indent" href="index.html" target="_blank" title="VIPABC">index.html</a>
        <ul class="LR-tab-title">
        	<li class="LR-item-on">会员登录</li>
            <li>立即注册</li>
        </ul>

    </div>
    <!-- LR-content-wrap -->
    <div class="LR-content-wrap">
    	<div class="LR-content LR-content-show">
        	<form id="pc-login" action="" method="post" autocomplete="off">
                <ul>
                    <li class="LR-wrap-input-wrap LR-username"><span class="LR-span"><i></i><input class="LR-wrap-input focus_on" id="login_username" name="username" type="text"  placeholder="用户名" /></span></li>
                    <li id="none-pwd" class="LR-wrap-input-wrap LR-pwd"><span class="LR-span"><i></i><input id="login_password" class="LR-wrap-input" name="password" type="password" placeholder="密码" /></span></li>
                    <li class="LR-wrap-checkbox-wrap">
                        <a id="forget-pwd" href="#" target="_blank">忘记密码？</a>
                        <label id="noneuser-log"><input type="checkbox" style="vertical-align:-2px;" />&nbsp;&nbsp;记住登录</label>
                     </li>
                     <li class="LoginOthers-wrap">
                        <span id="tudouLogin" class="LoginOthers tudouLogin"></span>
                        <span id="doubanLogin" class="LoginOthers doubanLogin"></span>
                        <span>第三方登录</span>
                     </li>
                    <li><input id="login_submit" class="LR-wrap-btn" type="submit" value="登录" /></li>
                </ul>
            </form>
            <span id="alter1"></span>
    	</div>
        <div class="LR-content">
        	<form id="pc-register" action="" method="post" autocomplete="off">
                <ul>
                	<li class="LR-wrap-input-wrap LR-username"><span class="LR-span"><i></i><input class="LR-wrap-input focus_on" id="register_username" name="username" type="text"  placeholder="用户名" /></span></li>
                    <li class="LR-wrap-input-wrap LR-mail"><span class="LR-span"><i></i><input class="LR-wrap-input focus_on" id="register_email" name="email" type="email" placeholder="邮箱" /></span></li>
                    <li class="LR-wrap-input-wrap LR-pwd"><span class="LR-span"><i></i><input class="LR-wrap-input" id="register_password" name="password" type="password" placeholder="密码" /></span></li>
                    <li class="LR-wrap-input-wrap LR-pwd"><span class="LR-span"><i></i><input class="LR-wrap-input" id="register_repasswd" name="password[twice]" type="password" placeholder="确认密码" /></span></li>
                    <li><input class="LR-wrap-btn" id="register_submit" type="submit" value="注册" /></li>
               </ul>
           </form>
           <span id="alter2"></span>
    	</div>
    </div>

    <div class="clear"></div>
</div>

<div class="wrapper">

	<header class="header h-header">
    	<a class="logo" href="#"><img src="images/logo.png" width="73" height="45" alt="喵众" /></a>

		<ul class="log-wrap">
        	<li class="log">&nbsp;登录&nbsp;</li>
            <li class="log">&nbsp;注册&nbsp;</li>
        </ul>
        <ul class="login-wrap">
            <li id="curname" class ="log"></li>
            <li id="logout" class="log">&nbsp;退出&nbsp;</li>
        </ul>
        <h2 class="video-title"><span id="video-title"></span><span class="shareLink">分享链接</span></h2>
    </header>

    <!-- container -->
    <div class="container">
    	<div class="player-wrap">
            <!-- user list -->
            <div class="home-col-R">
                <div class="user-list">
               	 	<ul id='user-list'>
                    </ul>
                </div>
       	    </div>
            <!-- user list end -->

        	<!-- video-wrap -->
        	<div class="home-col-L">
                <div class="video-wrap">
                    <video id="catties_video_player" class="video-js vjs-default-skin" controls preload="none" width="99.7%" height="408"
                          poster="images/oceans-clip.png"
                          data-setup="{}">

                   </video>
                </div>
        	</div>
            <!-- video-wrap end -->
        </div>


        
        <!-- chat list -->
        <div class="chat-list-wrap">

            <ul id="content">
            </ul>

        </div>
        <!-- chat list end -->
		
		<div class="voice-btn-wrap">
        	<input id="voice-online" class="voice-btn" type="button" />
        </div>

        <div class="comment-wrap">
        	<input class="comment-submit" id="sendMsg" type="submit" value="提交" />
        	<span><textarea class="comment-area" id="msg"
        	cols="123" rows="123" placeholder="写点什么...喵"
        	onkeypress="return runScript(event)"></textarea></span>
        </div>


	</div>
    <!-- container end -->
	<div id="result"></div>
    <div class="clear"></div>

</div>



<div class="create-link-wrap">
	<span></span>
    <h2>链接已生成,快分享给小伙伴们！</h2>
    <p id="created-link">http://www.tudou.com/albumplay/Lqfme5hSolM/xJgSB3fMBoA.html</p>
    <div><input id="copy-link-btn" class="copy-link-btn" type="button" value="复制" /></div>
</div>


<script src="plugins/video.js"></script> <!-- plugins videojs -->
<script src="js/avos/av.js"></script>

<script src="js/DAO.js"></script>
<script src="js/common.js"></script> <!-- common js -->
<script src="js/checker.js"></script>
<script src="video/videoUtil.js"></script>
<script src="js/chat.js"></script>
<script src="js/cattie_chat.js"></script>
<script src="js/getQueryVariable.js"></script>
<script src="js/OAuthLogin.js"></script>
<script src="js/simpleWebrtc.js"></script>
<script src="js/simpleWebrtcMain.js"></script>




<script>
var page = "home";
var userDAO = new UserDao();
var sessionDAO = new SessionDao();
var videoDAO = new VideoDao();
var videoUtil =  new VideoUtil();

var user = null;
var video = null;
var real_video_url = null;
var session = null;
var decoded = null;
var player = videojs('catties_video_player');

registerPlayerEvent();
function showParticipants(session){
	//TODO
};

function initGroup(sync, group, isowner){
	//TODO
};

function initGroup(sync, group, isowner){

};

function createGroup(callback){
	var sync = 1111;
	var chat = 2222;
	callback(sync, chat);
};

function initPlayer(real_video_url){
	player.src(real_video_url);
    startChatClient();
	//sleep(60);
	// player.play();
}

function enableGenerate(session_url){
	$("#created-link").html(session_url);
}

String.prototype.trim=function() {
    return this.replace(/(^\s*)|(\s*$)/g,'');
};

var _real_url="http://k.youku.com/player/getFlvPath/sid/441308937575012f0d7a9_01/st/mp4/fileid/03002001005438FAA3FECE03BAF2B1A4977D95-AC6D-ACF9-BE3F-429B27630251?K=208ae384cffdeb392411f7e3&hd=0&ymovie=1&myp=0&ts=2699&ypp=2&ctype=12&ev=1&token=7840&oip=3663591661&ep=diaVGUmFX80H4CTaiD8bMSy2cyYGXP4J9h%2BHgdJjALshTOu370%2BgxOvFPYpCFYtoBCB0EZr1otfgHkkRYYEwrxwQrj3eMPqSi%2FOV5alRzeICYR81cs%2FStVSZSzTx";
$(document).ready(function(){
	checker();
	$("#copy-link-btn").zclip({
		path: "js/vendor/ZeroClipboard.swf",
		copy: function(){
			return $("#created-link").text();
		},
		afterCopy: function(){
			//$("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功').fadeOut(2000);
			alert("复制成功");
		}
	});
	//var encoded = vurlencode("http://www.tudou.com/albumplay/jGaFpdJqObQ/sArqU-hBvjw.html");
	//console.log(encoded);
	var video_url = GetQueryString("url");
	console.log(video_url);
	var session_id = GetQueryString("session_id");
	console.log(session_id);
	if(session_id != null){
		session_id = vurldecode(session_id);
	}
	console.log(session_id);
	decoded = vurldecode(video_url);
	console.log(decoded);

		user = userDAO.getuser();
		if(session_id != null){
			sessionDAO.getSession(session_id,function(data){
				session = data;
				if(session.get("owner") != data.id){
					console.log("not owner");
				}else{
					console.log("owner");
					$(".shareLink").css("display", "inline-block");
				}

				videoDAO.getVideo(session.get("video"), function(data){
					video = data;
					$("#video-title").text(video.get("title"));
					initGroup(session.get("sync"), session.get("group"), session.get("owner") == user.id);
					parseRealUrl(video.get("url"), function(data){
						real_video_url = data;
						initPlayer(real_video_url);
					});
				});
                chatOnReady();
			});

		}else{
			videoUtil.getInfo(decoded, function(info){
				videoDAO.getOrCreateVideo(video_url, info.results[0], function(data){
					video = data;
					$(".shareLink").css("display", "inline-block");
					$("#video-title").text(video.get("title"));
					sessionDAO.createSession(user.id, video.id, function(data){
						session = data;
						createGroup(function(sync, group){
							sessionDAO.setGroup(session.id, sync, group);
						});
                        chatOnReady();
					});
					if(!video.get("real_url")){
						parseRealUrl(video_url, function(data){
							//alert(data);
							real_video_url = data;
							videoDAO.setRealUrl(video, real_video_url);
							initPlayer(real_video_url);
						});
					}else{
						real_video_url = video.get("real_url");
						initPlayer(real_video_url);
					}
				});
			});
		}
		checkUser();
});

function checkUser(){
	if (user.get("username") == null) {
		$("#msg").hide();
		$("#sendMsg").hide();
	} else {
		$("#msg").show();
		$("#sendMsg").show();
	}
}

function addChatContent() {
        var li = document.createElement("li");
        var em = $("<em></em>").text(userDAO.getuser().get('username'))[0];
        li.appendChild(em);
        var span = document.createElement("span");
        var div = $("<div></div>").text($('#msg')[0].value)[0];
        $('#msg')[0].value = "";
        var currentdate = new Date();
        var dateTime =  currentdate.getHours() + ":"
                + currentdate.getMinutes();

        div.appendChild($("<i></i>").text(dateTime)[0]);
        div.appendChild($("<strong></strong>").text("")[0]);
        span.appendChild(div);
        li.appendChild(span);
        $('#content')[0].appendChild(li);
}

$('#sendMsg')[0].onclick = function() {
         sendGroupMessage($('#msg')[0].value);
        addChatContent();
      };

var count = true;
$('#voice-online')[0].onclick = function() {
	if (count) {
		startWebrtc();
		join(groupId);
		count = false;
	} else {
		stopWebrtc();
		count = true;
	}
};
function runScript(e) {
    if (e.keyCode == 13 && e.shiftKey) {
        // prevent default behavior
        $('#msg')[0].value += '\n';
    } else if (e.keyCode == 13) {
        $('#sendMsg')[0].onclick();
        return false;
    }
}

</script>
</body>
</html>
